name: Deploy Strapi To VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-strapi-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on VPS over SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
        run: |
          set -euo pipefail

          for var in VPS_HOST VPS_USER VPS_SSH_KEY VPS_APP_DIR; do
            if [ -z "${!var:-}" ]; then
              echo "Missing required GitHub secret: $var"
              exit 1
            fi
          done

          PORT="${VPS_PORT:-22}"

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s' "$VPS_SSH_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          ssh-keyscan -p "$PORT" -H "$VPS_HOST" >> "$HOME/.ssh/known_hosts"

          ssh -i "$HOME/.ssh/id_ed25519" -p "$PORT" "$VPS_USER@$VPS_HOST" "cd \"$VPS_APP_DIR\" && ./scripts/vps-deploy-main.sh"
