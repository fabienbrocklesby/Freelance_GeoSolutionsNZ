---
import Layout from "../../layouts/DefaultLayout.astro";
import { fetchAPI, getFileUrl } from "../../lib/api.js";

const result = await fetchAPI("documents?populate=file");
const documentsData = result?.data ?? [];
const documents = documentsData.map((document) => {
	const fileData = document.attributes.file?.data?.attributes;
	return {
		id: document.id,
		title: document.attributes.title,
		description: document.attributes.description,
		externalUrl: document.attributes.url,
		...(fileData && {
			fileName: fileData.name,
			fileUrl: getFileUrl(fileData.url),
		}),
	}
}).reverse();
---

<Layout title="Publications">
	<section
		id="publications"
		class="pt-40 pb-16 bg-gray-50 min-h-screen"
		data-aos="fade-in"
		data-aos-duration="1000"
		data-aos-once="true"
	>
		<div class="container mx-auto px-4">
			<div class="text-center mb-12">
				<h1 class="text-4xl font-bold text-primary mb-2">Publications</h1>
				<p class="text-xl text-gray-600">
					Explore our collection of relevant documents
				</p>
			</div>
			<div class="flex justify-center">
				<ul class="w-full max-w-4xl space-y-6">
					{
						documents.map((document) => (
							<li class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow duration-300 border border-neutral rounded-lg overflow-hidden">
								<div class="card-body p-6 flex flex-col">
									<h2 class="text-2xl font-semibold text-primary mb-3">
										{document.title}
									</h2>
									<p class="text-gray-600 mb-4">{document.description}</p>
									<div class="flex flex-wrap justify-between items-center gap-3">
										{document.fileName ? (
										<span class="text-sm text-gray-500 truncate min-w-0 flex-1">
											{document.fileName}
										</span>
										
										<a
											href={document.fileUrl}
											class="btn btn-primary text-white shrink-0"
											download
											id="autoDownloadLink"
										>
											Download
										</a>
										): (
										<a href={document.externalUrl} class="btn btn-primary text-white shrink-0">
											View External Document
										</a>
										)}
									</div>
								</div>
							</li>
						))
					}
				</ul>
			</div>
		</div>
	</section>
</Layout>
