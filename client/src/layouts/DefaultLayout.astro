---
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import AnnouncementBanner from "../components/AnnouncementBanner.astro";
import { fetchAPI, getImageUrl } from "../lib/api.js";
import { seoDefaults } from "../lib/constants.js";
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  noIndex?: boolean;
}

const { title, description, ogImage, noIndex = false } = Astro.props;

const siteName = "GeoSolutions";
const siteData = await fetchAPI("site-setting?populate=seo.ogImage");
const seo = siteData?.data?.seo || {};

const finalTitle = title || seo.metaTitle || seoDefaults.metaTitle;
const finalDescription =
  description || seo.metaDescription || seoDefaults.metaDescription;
const seoOgImagePath = seo.ogImage?.url || seo.ogImage?.data?.attributes?.url;
const finalOgImage =
  ogImage ||
  (seoOgImagePath ? getImageUrl(seoOgImagePath) : "/images/og-default.jpg");
const canonicalUrl = Astro.url.href;
---

<html lang="en" data-theme="defaultTheme">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{finalTitle}</title>
    <meta name="description" content={finalDescription} />
    <link rel="canonical" href={canonicalUrl} />
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <meta property="og:title" content={finalTitle} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={finalOgImage} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={finalTitle} />
    <meta name="twitter:description" content={finalDescription} />
    <meta name="twitter:image" content={finalOgImage} />

    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/aos.css" />
  </head>
  <body>
    <AnnouncementBanner />
    <div class="overflow-x-hidden">
      <div id="navbar">
        <Navbar />
      </div>

      <div>
        <slot />
      </div>

      <div id="footer">
        <Footer />
      </div>
    </div>
  </body>

  <script is:inline src="/js/aos.js"></script>
  <script is:inline src="/js/navbar.js"></script>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
      if (typeof AOS !== "undefined") {
        AOS.init();
      }
    });
  </script>
</html>
